{% extends 'base.html' %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'ElectricityCSS/style.css' %}">

    <h1 class="color-white-title-home">Stay Charged: Hassle-Free Electricity Bill Payments!</h1>
    <div class="carousel-container">
        <div class="carousel">
            <div class="carousel-images">
                <img src="https://www.ikejaelectric.com/wp-content/uploads/2020/03/Ikeja-Electric.jpg" id="Ikeja-electric" alt="Ikeja Electricity Payment" class="carousel-image">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQloSv2EA95GWteNFQ92menPxXEDm10AWIbqA&s" id="eko-electric" alt="Eko Electricity Payment" class="carousel-image">
                <img src="https://ait.live/wp-content/uploads/2024/06/AIT-IMAGES-4-1.png" id="abuja-electric" alt="Abuja Electricity Distribution Company- AEDC" class="carousel-image">
                <img src="https://nairadata.com.ng/wp-content/uploads/2020/07/Kano-Electric.jpg" id="kano-electric" alt="KEDCO - Kano Electric" class="carousel-image">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR5XUXI5rFKP0fkues4k_LQ0FfPRxoDvWR5YA&s" id="portharcourt-electric" alt="PHED - Port Harcourt Electric" class="carousel-image">
                <img src="https://pbs.twimg.com/profile_images/898118928404295681/qqSdt2Ir_400x400.jpg" id="jos-electric" alt="Jos Electric - JED" class="carousel-image">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRNG7zor5MbIm3di44lL51qAIMQIt-bqrlPZA&s" id="kaduna-electric" alt="Kaduna Electric - KAEDCO" class="carousel-image">
                <img src="https://pbs.twimg.com/profile_images/1162387741910454275/WF1aMEiU_400x400.jpg" id="enugu-electric" alt="Enugu Electric - EEDC" class="carousel-image">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSnpU2-RwCZVmMLVlj-hFd_k6sBnxzemkD__w&s" id="ibadan-electric" alt="IBEDC - Ibadan Electricity Distribution Company" class="carousel-image">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRCZ9oJUd7dxVJrQRBgQv5LWnHE5QjYgrylXA&s" id="benin-electric" alt="Benin Electricity - BEDC" class="carousel-image">
                <img src="https://media.licdn.com/dms/image/v2/C4E0BAQHO6lxDRjwQIQ/company-logo_200_200/company-logo_200_200/0/1670230041021?e=2147483647&v=beta&t=Y9Qj5dCj82KMLNblF1TX2Ux4dUwhUWtObjRij5MzKLg" id="aba-electric" alt="Aba Electric Payment - ABEDC" class="carousel-image">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRdetOBuUodzK4QU13Kmfnr9RRmaKe2ap91tQ&s" id="yola-electric" alt="Yola Electric Disco Payment - YEDC" class="carousel-image">
            </div>
            <span class="carousel-btn prev-btn">&#10094;</span>
            <span class="carousel-btn next-btn">&#10095;</span>
        </div>
        <div class="carousel-dots">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
        </div>
    </div>
    <!-- Form Below the Carousel -->
    <div class="form-container">
        <article class="formHeading" style="text-align: center;">
            <p>Pay Your Electricity Bill With BigSheriffData</p>
            <h2 class="image-name"></h2>
        </article>
        <form id="form" method="POST">
            {% csrf_token %} 
            <div class="form-group">
                <label for="{{ form.serviceID.id_for_label }}">Electricity:</label>
                {{ form.serviceID }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.meter_number.id_for_label }}">Meter Number:</label>
                {{ form.meter_number }}
                {% for error in form.meter_number.errors %}
                    <div class="error">{{ error }}</div>
                {% endfor %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.meter_type.id_for_label }}">Meter Type:</label>
                <select name="meter_type" id="meter-type" required>
                    <option value="" selected disabled>Select Meter Type</option>
                    <option value="Prepaid">Prepaid</option>
                    <option value="Postpaid">Postpaid</option>
                </select>
            </div>
        
            <div class="form-group">
                <label for="{{ form.phone_number.id_for_label }}">Phone Number:</label>
                {{ form.phone_number }}
            </div>
        
            <div class="form-group">
                <label for="{{ form.amount.id_for_label }}">Amount:</label>
                {{ form.amount }}
            </div>
        
            <button type="submit" id="submit-btn">Pay Now</button>
            <button type="button" id="loading-btn" style="display: none;" disabled>
                <span>Please Wait...<i class="fa fa-spinner fa-spin"></i></span>
            </button>
        </form>
        
    </div>

    <script src="{% static 'ElectricityCSS/script.js' %}"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    $(document).ready(function() {
        // Show SweetAlert if user balance is below 50
        {% if user_balance < 50 %}
        Swal.fire({
            icon: 'warning',
            title: 'Balance Too Low',
            text: 'Your balance is too low to make this transaction. Please top up your account.',
            confirmButtonText: 'OK'
        }).then(() => {
            // Redirect after the alert
            window.location.href = "{% url 'index' %}";
        });
        {% endif %}

        // Function to check the meter number length
        function checkAndValidateForm() {
            // Get the values from the input fields
            var serviceID = $('#serviceID').val();  // Assuming 'id_serviceID' is the ID of the serviceID input field
            var meterNumber = $('#meter_number').val();  // Assuming 'id_meter_number' is the ID of the meter number input field
            var meterType = $('#meter-type').val();  // Assuming 'meter-type' is the ID of the meter type input field

            // Check if the meter number has at least 10 characters, and other fields are filled
            if (meterNumber.length >= 10 && serviceID && meterType) {
                // Trigger the validation call to the backend
                $.ajax({
                    url: "/api/electricity-bill/",  // Validation endpoint
                    type: 'POST',
                    data: {
                        serviceID: serviceID,
                        meter_number: meterNumber,
                        meter_type: meterType,
                        csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val() // Include CSRF token
                    },
                    success: function(response) {
                        if (response.valid) {
                            // Validation passed
                            $('#submit-button').prop('disabled', false);  // Enable the submit button
                            Swal.fire({
                                icon: 'success',
                                title: 'Validation successful!',
                                html: `
                                    <strong>Customer Name:</strong> ${response.content.Customer_Name} <br>
                                    <strong>Address:</strong> ${response.content.Address} <br>
                                    <strong>Meter Number:</strong> ${response.content.Meter_Number} <br>
                                    <strong>Customer Arrears:</strong> ${response.content.Customer_Arrears} <br>
                                    <strong>Meter Type:</strong> ${response.content.Meter_Type}
                                `
                            });
                        } else {
                            // Validation failed
                            $('#submit-button').prop('disabled', true);  // Disable the submit button
                            Swal.fire({
                                icon: 'error',
                                title: 'Validation failed',
                                text: response.message
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Validation failed',
                            text: error
                        });
                        $('#submit-button').prop('disabled', true);  // Disable the submit button in case of an error
                    }
                });
            } else {
                // Disable submit button if conditions are not met
                $('#submit-button').prop('disabled', true);
            }
        }

        // Set up event listeners on the input fields
        $('#id_serviceID, #id_meter_number, #meter-type').on('input', function() {
            checkAndValidateForm();  // Check and validate whenever there is an input change
        });

        $('#form').submit(function(event) {
            event.preventDefault(); // Prevent the default form submission

            // Show the loading button and hide the submit button
            $('#submit-btn').hide();
            $('#loading-btn').show();

            // Disable the submit button to prevent multiple submissions
            $('button[type="submit"]').prop('disabled', true);
            
            // Gather the form data
            var formData = $(this).serialize();

            // Use AJAX to submit the form data
            $.ajax({
                url: "/api/electricity-bill/",  // Replace with your actual view URL
                type: 'POST',
                data: formData,
                success: function(response) {
                    // Handle success response
                    if (response.success) {
                        // Construct the message for success
                        let message = `
                            ${response.message} <br><br>
                            <strong>Remaining Balance:</strong> ${response.remaining_balance}
                        `;
                        
                        // Show the SweetAlert with customized button styles
                        Swal.fire({
                            icon: 'success',
                            title: 'Payment successful!',
                            html: message,
                            showCancelButton: true,
                            cancelButtonText: 'Ok',
                            confirmButtonText: 'View Receipt',
                            customClass: {
                                // Customize the "View Receipt" button
                                confirmButton: 'swal-view-receipt-button',
                                cancelButton: 'swal-cancel-button'
                            },
                            // Optional: Add additional button customization
                            buttonsStyling: false // Disable default button styling
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // Store the full response in localStorage (or sessionStorage)
                                localStorage.setItem('receiptData', JSON.stringify(response.content));
                                
                                // Redirect to the receipt page
                                window.location.href = '/receipt';
                                $('#form')[0].reset();
                            } else {
                                // Optionally, clear the form after successful submission
                                $('#form')[0].reset(); // Reset the form fields
                            }
                            // Hide the loading button and show the submit button again
                            $('#loading-btn').hide();
                            $('#submit-btn').show();
                        });
                    } else {
                        // Handle error response
                        Swal.fire({
                            icon: 'error',
                            title: 'There was an error',
                            text: response.message
                        }).then(() => {
                            // Clear the form after failed submission
                            $('#form')[0].reset(); // Reset the form fields
                        });
                    }
                    // Hide the loading button and show the submit button again
                    $('#loading-btn').hide();
                    $('#submit-btn').show();
                    // Re-enable the submit button
                    $('button[type="submit"]').prop('disabled', false);
                },
            });
        });
    });
</script>



{% endblock content %}