{% extends 'base.html' %}
{% load static %}

{% block content %}

    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.2/dist/sweetalert2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <link rel="stylesheet" href="{% static 'DataCSS/assets/style.css' %}" />

    <div class="container">
        <div class="circle-container">
            <div class="circle" id="circle1" style="background-image: url('https://upload.wikimedia.org/wikipedia/commons/9/93/New-mtn-logo.jpg');" data-network="MTN">
                <div class="checkmark">✔</div>
            </div>
            <div class="circle" id="circle2" style="background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSIld5zDrdD73UXq1qRvX7fwf7gQQ3wFjP7-g&s');" data-network="Airtel">
                <div class="checkmark">✔</div>
            </div>
            <div class="circle" id="circle3" style="background-image: url('https://www.ikonlinestore.com/wp-content/uploads/2020/06/glo.jpg');" data-network="Glo">
                <div class="checkmark">✔</div>
            </div>
            <div class="circle" id="circle4" style="background-image: url('https://www.thecable.ng/wp-content/uploads/2017/07/9mobile-e1554374273945.jpg');" data-network="9mobile">
                <div class="checkmark">✔</div>
            </div>
        </div>

        <!-- <div class="form-container" id="formContainer">
            <form class="formStyle step" id="buyDataForm" novalidate>
                {% csrf_token %}
                <article class="formHeading">
                    <p>TopUp your Data With BigSheriffData</p>
                    <h2 id="networkName">Data Bundles</h2>
                </article>
                <div class="inputField">
                    <label>Network</label>
                    <input type="text" id="network" name="network" readonly> 
                </div> -->
                <!-- Hidden Original Data Plan Field -->
                <!-- <div class="inputField inputFieldDropdown" style="display: none;">
                    <label>Data Plan</label>
                    <select name="data_plan" id="dataPlan">
                        <option value="" disabled selected>Select a Data Plan</option> -->
                        <!-- Options will be populated dynamically by JS -->
                    <!-- </select>
                </div> -->

                <!-- Visible Data Plan + ₦10 Field -->
                <!-- <div class="inputField inputFieldDropdown">
                    <label>Data Plan</label>
                    <select name="data_plan_plus" id="dataPlanPlus">
                        <option value="" disabled selected>Select a Data Plan</option> -->
                        <!-- Will be filled dynamically -->
                    <!-- </select>
                </div>
                
                <div class="inputField inputFieldDropdown" id="gloDataTypeContainer" style="display: none;">
                    <label>Data Type</label>
                    <select name="data_type" id="gloDataType">
                        <option value="Glo Data">Glo Data</option>
                        <option value="Glo SME Data">Glo SME Data</option>
                    </select>
                </div>

                <div class="inputField inputFieldDropdown" id="nineMobileDataTypeContainer" style="display: none;">
                    <label>Data Type</label>
                    <select name="data_type" id="nineMobileDataType">
                        <option value="9mobile Data">9mobile Data</option>
                        <option value="9mobile SME Data">9mobile SME Data</option>
                    </select>
                </div>               

                <div class="inputField">
                    <label>Mobile Number</label>
                    <input type="text" name="mobile_number" maxlength="11" minlength="11" required=""/>
                </div>
                <div class="inputField">
                    <label>Amount</label>
                    <input type="text" name="amount" id="amountField" maxlength="11" minlength="2" required="" disabled/>
                </div>                
                <button type="submit" class="form-Btn w-100" id="submitButton">
                    Buy Now
                </button>
                <button type="button" id="loadingSpinner" class="form-Btn w-100"  style="display: none;" disabled>
                    <span>Please Wait...<i class="fa fa-spinner fa-spin"></i></span>
                </button>
                
            </form> -->
            <!-- Loading Spinner HTML -->
            <!-- <div id="loading-spinner" class="loading-spinner" style="display: none;">
                <div class="spinner"></div>
                <p>Please wait...</p>
            </div>
        </div> -->

        <div class="form-container modern" id="formContainer">
            <form class="formStyle step" id="buyDataForm" novalidate>
                {% csrf_token %}
                <article class="formHeading">
                    <p>Top Up Your Data</p>
                    <h2 id="networkName">Data Bundles</h2>
                </article>
    
                <div class="inputField floating-label-group readonly">
                    <input type="text" id="network" name="network" placeholder=" " readonly>
                    <label for="network">Network</label>
                    <span class="focus-border"></span>
                </div>
                
                <!-- Hidden Original Data Plan Field -->
                <div style="display: none;">
                    <select name="data_plan" id="dataPlan">
                        <option value="" disabled selected>Select a Data Plan</option>
                    </select>
                </div>

                <!-- Visible Data Plan + ₦10 Field -->
                <div class="inputField select-group">
                    <label for="dataPlanPlus">Data Plan</label>
                    <select name="data_plan_plus" id="dataPlanPlus" required>
                        <option value="" disabled selected>Select available plan...</option>
                    </select>
                </div>
    
                <div class="inputField select-group" id="gloDataTypeContainer" style="display: none;">
                    <label for="gloDataType">GLO Data Type</label>
                    <select name="data_type_glo" id="gloDataType">
                        <option value="Glo Data">Glo Data</option>
                        <option value="Glo SME Data">Glo SME Data</option>
                    </select>
                </div>
    
                <div class="inputField select-group" id="nineMobileDataTypeContainer" style="display: none;">
                    <label for="nineMobileDataType">9mobile Data Type</label>
                    <select name="data_type_9mobile" id="nineMobileDataType">
                        <option value="9mobile Data">9mobile Data</option>
                        <option value="9mobile SME Data">9mobile SME Data</option>
                    </select>
                </div>
    
    
                <div class="inputField floating-label-group">
                    <input type="tel" id="mobileNumber" name="mobile_number" placeholder=" " inputmode="tel" pattern="[0-9]{11}" maxlength="11" minlength="11" required />
                    <label for="mobileNumber">Mobile Number</label>
                    <span class="focus-border"></span>
                </div>
    
                <div class="inputField floating-label-group readonly">
                    <input type="text" name="amount" id="amountField" placeholder=" " required readonly />
                    <label for="amountField">Amount (₦)</label>
                    <span class="focus-border"></span>
                </div>
    
                <button type="submit" class="form-Btn modern w-100" id="submitButton">
                    <span class="btn-text">Purchase Data</span>
                    <span class="btn-spinner" style="display: none;">
                        <i class="fa fa-spinner fa-spin"></i> Processing...
                    </span>
                </button>
    
            </form>
            <p class="form-footer-note">Secured Transaction</p>
        </div>

        <div id="loading-spinner" class="loading-spinner" style="display: none;">
            <div class="spinner"></div>
            <p>Please wait...</p>
        </div>
        
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{% static 'DataCSS/assets/script.js' %}"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.2/dist/sweetalert2.min.js"></script>
    <script>
        $(document).ready(function() {
            // Show SweetAlert if user balance is below 50
            {% if user_balance < 50 %}
            Swal.fire({
                icon: 'warning',
                title: 'Balance Too Low',
                text: 'Your balance is too low to make this transaction. Please top up your account.',
                confirmButtonText: 'OK'
            }).then(() => {
                // Redirect after the alert
                window.location.href = "{% url 'index' %}";
            });
            {% endif %}
            
            // Handle network circle selection
            $('.circle').click(function() {
                var network = $(this).data('network');
                var networkMap = {
                    "MTN": 1,
                    "Airtel": 4,
                    "Glo": 2,
                    "9mobile": 3
                };
                var networkId = networkMap[network];
                $('#network').val(network);  // Display the network name in the text field
                $('#network').data('network-id', networkId); // Store the network number in a data attribute
            });

            // Enable amount field before submitting
            $('#buyDataForm').submit(function(e) {
                e.preventDefault();  // Prevent the default form submission

                document.getElementById('loading-spinner').style.display = 'flex';

                // Show loading spinner and change button text
                // $('#submitButton').hide(); // hide the submit button
                // $('#loadingSpinner').show();  // Show the loading spinner

                var $submitButton = $('#submitButton');
                var $buttonText = $submitButton.find('.btn-text');
                var $buttonSpinner = $submitButton.find('.btn-spinner');

                // --- Show Loading State ---
                $buttonText.hide();
                $buttonSpinner.css('display', 'inline-flex');
                $submitButton.prop('disabled', true).addClass('loading');

                // Check if the mobile number field is empty
                var mobileNumber = $('input[name="mobile_number"]').val();
                if (!mobileNumber) {
                    document.getElementById('loading-spinner').style.display = 'none';
                    $buttonSpinner.css('display', 'none');
                    $submitButton.prop('disabled', false).addClass('loading');
                    $buttonText.show();
                    // Show SweetAlert if mobile number is not entered
                    Swal.fire({
                        icon: 'warning',
                        title: 'Mobile Number Missing',
                        text: 'Please enter your mobile number.',
                        confirmButtonText: 'OK'
                    });
                    return;  // Stop the form submission
                }

                // Get the amount from the amountField and remove the "N" prefix
                var amount = $('#amountField').val().replace('N', '');  // Remove the "N" character

                // Check if the amount is empty or not a valid number
                if (!amount || isNaN(amount) || amount <= 0) {
                    document.getElementById('loading-spinner').style.display = 'none';
                    $buttonSpinner.css('display', 'none');
                    $submitButton.prop('disabled', false).addClass('loading');
                    $buttonText.show();
                    // Show SweetAlert if the amount is not entered or invalid
                    Swal.fire({
                        icon: 'warning',
                        title: 'Invalid Amount',
                        text: 'Please enter a valid amount greater than zero.',
                        confirmButtonText: 'OK'
                    });
                    return;  // Stop the form submission
                }

                // Ensure the amount field is enabled and has a valid value
                $('#amountField').prop('disabled', false);  // Enable the amount field if it's disabled

                // Update the amount value in the hidden input field (if necessary)
                $('#amountField').val(amount);  // This ensures the amount is sent without the "N" prefix

                // Get the network value (number) from the data attribute
                var networkId = $('#network').data('network-id');

                // Add the network ID to the form data
                var formData = $(this).serialize();  // Serialize the form data
                formData += "&network=" + networkId;  // Append the network ID

                // Add the user ID from the server context (ensure the user ID is passed from Django)
                formData += "&user={{ user.id }}";  // Add user ID to the form data

                // Send the data using AJAX
                $.ajax({
                    url: "/api/buy-data/",  // Your API endpoint
                    type: "POST",
                    data: formData + "&data_plan=" + $('#dataPlan').val(),  // Add necessary data
                    success: function(response) {
                        document.getElementById('loading-spinner').style.display = 'none';

                        if (response.message) {
                            // Success response handling
                            Swal.fire({
                                icon: 'success',
                                title: 'Data Purchase Successful!',
                                text: 'Data purchase successful! Your remaining balance is: ₦' + response.remaining_balance,
                                confirmButtonText: 'OK'
                            }).then(() => {
                                // Optionally, redirect after success
                                window.location.href = "{% url 'index' %}"; // Adjust this URL as needed
                            });

                            // Optionally reset the form
                            $('#buyDataForm')[0].reset();
                            $('#amountField').prop('disabled', true);
                            $buttonSpinner.css('display', 'none');
                            $submitButton.prop('disabled', false).addClass('loading');
                            $buttonText.show();
                        } else {
                            document.getElementById('loading-spinner').style.display = 'none';
                            // Handle error response
                            Swal.fire({
                                icon: 'error',
                                title: 'Data Purchase Failed!',
                                text: response.error,  // Display the error string
                                confirmButtonText: 'OK'
                            }).then(() => {
                                // Clear the form after failed submission
                                $('#buyDataForm')[0].reset();
                                $('#amountField').prop('disabled', true);
                                $buttonSpinner.css('display', 'none');
                                $submitButton.prop('disabled', false).addClass('loading');
                                $buttonText.show();
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        document.getElementById('loading-spinner').style.display = 'none';
                        // Default error message
                        var errorMessage = "There was an error. Please try again.";

                        // Check if responseJSON exists
                        if (xhr.responseJSON) {
                            // Case 1: If there's an error field, extract the message
                            if (xhr.responseJSON.error) {
                                errorMessage = xhr.responseJSON.error; // If general error exists, use it
                            }

                            // Case 2: Handle the 'detail' field for error messages
                            if (xhr.responseJSON.detail) {
                                var detail = xhr.responseJSON.detail;

                                // Extracting the actual message from the 'detail' string
                                console.log("Detail:", detail); // Log the detail for debugging
                                
                                // If the detail is like this: "ErrorDetail(string='message', code='invalid')"
                                var regex = /string='([^']+)'/; // This will capture the message inside 'string=''
                                var matches = regex.exec(detail);
                                
                                if (matches && matches[1]) {
                                    errorMessage = matches[1];  // Extracted message (e.g., 'Insufficient balance to complete this purchase.')
                                }
                            }

                            if (xhr.responseJSON) {
                                // Check if 'detail' field exists and extract the actual error message
                                if (xhr.responseJSON.error) {
                                    var errorText = xhr.responseJSON.error;
                                    
                                    // Clean the error string to extract the actual message
                                    // Removing the unnecessary characters and extracting the message
                                    var regex = /string='(.*?)'/;
                                    var matches = regex.exec(errorText);

                                    if (matches && matches[1]) {
                                        errorMessage = matches[1];  // Extracted message
                                    }
                                }
                            }

                            // Case 3: If response contains 'details' with 'response_description', use it
                            if (xhr.responseJSON.details && xhr.responseJSON.details.response_description) {
                                var responseDescription = xhr.responseJSON.details.response_description;
                                errorMessage = responseDescription; // If there's a response description, use it
                            }
                        }

                        // Display the error message using SweetAlert
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: errorMessage,  // Display the error string
                            confirmButtonText: 'OK'
                        }).then(() => {
                            // Reset the form data if there is an error
                            $('#buyDataForm')[0].reset();
                            $('#amountField').prop('disabled', true);
                            $buttonSpinner.css('display', 'none');
                            $submitButton.prop('disabled', false).addClass('loading');
                            $buttonText.show();
                        });
                    }
                });
            });
        });

    </script>
    

{% endblock content %}
