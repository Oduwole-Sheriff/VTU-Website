{% extends 'base.html' %}
{% load static %}
{% block content %}

    <link rel="stylesheet" href="{% static 'AirtimeCSS/style.css' %}">

<div class="container">
    <div class="square-container">
        <!-- Squares with clickable text and checkmark -->
        <div class="square" onclick="showForm('MTN', this)" style="background-image: url('https://upload.wikimedia.org/wikipedia/commons/9/93/New-mtn-logo.jpg');"><div class="checkmark">✔</div></div>
        <div class="square" onclick="showForm('AIRTEL', this)" style="background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSIld5zDrdD73UXq1qRvX7fwf7gQQ3wFjP7-g&s');"><div class="checkmark">✔</div></div>
        <div class="square" onclick="showForm('GLO', this)" style="background-image: url('https://www.ikonlinestore.com/wp-content/uploads/2020/06/glo.jpg');"><div class="checkmark">✔</div></div>
        <div class="square" onclick="showForm('9MOBILE', this)" style="background-image: url('https://www.thecable.ng/wp-content/uploads/2017/07/9mobile-e1554374273945.jpg');"><div class="checkmark">✔</div></div>
    </div>

    <!-- Hidden form that will be displayed when a square is clicked -->
    <div class="form-container" id="form-container">
        <form class="formStyle step" id="buy-airtime-form" novalidate onsubmit="return false">
            <article class="formHeading">
                <p>TopUp your Airtime With BigSheriffData</p>
                <h2>Airtime TopUp</h2>
            </article>

            <div class="row">
                <div class="col-md-12">
                    <div class="inputField">
                        <label>Network</label>
                        <input type="text" id="network" readonly>
                    </div>
                </div>

                <div class="col-md-12">
                    <div class="inputField inputFieldDropdown">
                        <label>Airtime Type</label>
                        <select id="data_type">
                            <option value="voice">VTU</option>
                            <option value="data">Share and Sell</option>
                        </select>
                    </div>
                </div>

                <div class="col-md-12">
                    <div class="inputField">
                        <label>Mobile Number</label>
                        <input type="text" id="mobile_number" placeholder="Enter Mobile Number" required>
                    </div>
                </div>

                <div class="col-md-12">
                    <div class="inputField">
                        <label>Amount</label>
                        <input type="text" id="amount" placeholder="Enter Amount" required>
                    </div>
                </div>

                <!-- Bypass Validator Checkbox -->
                <div class="form-group">
                    <div class="check-wrapper">
                        <input type="checkbox" id="bypass_validator">
                        <label for="bypass_validator">Bypass Number Validator</label>
                    </div>
                </div>

                <div class="col-md-12">
                    <button type="submit" class="form-Btn">
                        Buy Now
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script src="{% static 'AirtimeCSS/script.js' %}"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>

    $(document).ready(function() {
        // Show SweetAlert if user balance is below 50
        {% if user_balance < 50 %}
        Swal.fire({
            icon: 'warning',
            title: 'Balance Too Low',
            text: 'Your balance is too low to make this transaction. Please top up your account.',
            confirmButtonText: 'OK'
        }).then(() => {
            // Redirect after the alert
            window.location.href = "{% url 'index' %}";
        });
        {% endif %}

        $('#buy-airtime-form').on('submit', function(event) {
            event.preventDefault();  // Prevent the default form submission

            // Serialize the form data
            var formData = $(this).serializeArray();
            var data = {};

            // Convert form data into an object
            $(formData).each(function(index, obj) {
                data[obj.name] = obj.value;
            });

            // Get CSRF token from the form's hidden input field
            var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

            // Send AJAX request
            $.ajax({
                url: '/api/buy-airtime/',  // URL where the form data is being sent
                type: 'POST',  // HTTP method
                data: JSON.stringify(data),  // Send data as JSON string
                contentType: 'application/json',  // Set content type to JSON
                headers: {
                    'X-CSRFToken': csrfToken  // Add CSRF token to the request headers
                },
                success: function(response) {
                    console.log(response)
                    if (response.status === 'success') {
                        // Success alert with remaining balance
                        Swal.fire({
                            icon: 'success',
                            title: 'Airtime Purchase Successful',
                            text: 'Remaining balance: ' + response.remaining_balance,
                            confirmButtonText: 'OK'
                        }).then(() => {
                            // Redirect after the success alert
                            window.location.href = "{% url 'index' %}";
                        });
                    } else {
                        // Error alert with message
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.message || 'An error occurred. Please try again.',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            // Reset the form data if the response is not successful
                            $('#buy-airtime-form')[0].reset();  // This clears all form fields
                        });
                    }
                },
                error: function(xhr, status, error) {
                    // Default error message
                    var errorMessage = 'An error occurred. Please try again later.';

                    // Check if response contains a "detail" or "errors" field
                    if (xhr.responseJSON) {
                        // Check if there are validation errors (e.g., invalid network choice)
                        if (xhr.responseJSON.errors) {
                            var errorText = '';
                            // Loop through all errors in the response
                            $.each(xhr.responseJSON.errors, function(field, messages) {
                                // Customize the error message for the 'data_type' and other fields
                                if (field === "data_type") {
                                    errorText += "Invalid choice in field: Data Type\n";
                                } else {
                                    errorText += "Invalid choice in field: " + field + "\n";
                                }
                            });
                            errorMessage = errorText;  // Set the error text
                        } else if (xhr.responseJSON.detail) {
                            // If a general error message exists (like "Insufficient balance")
                            errorMessage = xhr.responseJSON.detail;
                        }
                    }

                    // Display the error message in SweetAlert
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: errorMessage,
                        confirmButtonText: 'OK'
                    }).then(() => {
                        // Reset the form data if there is an error
                        $('#buy-airtime-form')[0].reset();  // This clears all form fields
                    });
                }
            });
        });
    });
</script>

{% endblock content %}
