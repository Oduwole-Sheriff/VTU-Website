{% extends 'base.html' %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'TVSubscriptionCSS/styles.css' %}">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.9/dist/sweetalert2.min.css">

<h1 class="color-white-title-home">Interactive TV Remote Control for TVSubscription</h1>

<div id="current-tv">
    <!-- Current TV image will be shown dynamically -->
</div>

<div id="form-container">
    <form id="tvForm">
        {% csrf_token %}
        <article class="formHeading" style="text-align: center;">
            <p>Subscribe On Your Favourite TV Cable With BigSheriffData</p>
            <h2>We've Got You Covered</h2>
        </article>

        <!-- Hidden field for TV service -->
        <input type="hidden" id="tv_service" name="tv_service" value="">

        <label for="smartcard-number" id="smartcard-label-DSTV" style="display: none;">DStv Smartcard Number:</label>
        <input type="text" placeholder="Enter your DStv Smartcard Number" id="smartcard-number-DSTV" name="smartcard-number" style="display: none;" required>

        <label for="iuc-number" id="smartcard-label-GOTV" style="display: none;">GOtv IUC NUMBER:</label>
        <input type="text" placeholder="Enter your GOtv IUC NUMBER" id="smartcard-number-GOTV" name="iuc-number" style="display: none;" required>

        <label for="startimes-smartcard" id="smartcard-label-STARTIMES" style="display: none;">Startimes Smartcard / eWallet Number:</label>
        <input type="text" placeholder="Enter your Startimes Smartcard / eWallet Number" id="smartcard-number-STARTIMES" name="startimes-smartcard" style="display: none;" required>
        
        <label for="action" id="action-label">What do you want to do?</label>
        <select id="action" name="action" required>
            <option value="" disabled selected>Select an option</option>
            <option value="renew">Renew Current Bouquet</option>
            <option value="change">Change Bouquet</option>
        </select>

        <label for="bouquet" id="bouquet-label" style="display: none;">Bouquet:</label>
        <select id="bouquet" name="bouquet" style="display: none;" required>
            <option value="" disabled selected>Select a bouquet</option>
            <!-- Options will be dynamically populated -->
        </select>

        <label for="type" id="type-label" style="display: none;">TYPE</label>
        <select id="type" name="type" style="display: none;" required>
            <option value="" disabled selected>Select a type</option>
            <option value="full">Full - N2,900</option>
            <option value="mobile_only">Mobile Only - N1,450</option>
            <option value="sports_full">Sports Full - N6,300</option>
            <option value="sports_mobile_only">Sports Mobile Only - N3,200</option>
        </select>

        <label for="phone-number">Phone Number:</label>
        <input type="tel" placeholder="Enter Mobile Number" id="phone-number" name="phone-number" required>

        <label for="amount">Amount:</label>
        <input type="number" placeholder="Amount" id="amount" name="amount" required>

        <!-- Submit Button with Loading State -->
        <button type="submit" class="form-Btn" id="submit-btn">Submit</button>
        <button type="button" id="loading-btn" class="form-Btn" style="display: none;" disabled>
            <span>Please Wait...<i class="fa fa-spinner fa-spin"></i></span>
        </button>

    </form>
</div>

<div class="tv-images">
    <!-- Remote Control image -->
    <img src="{% static 'TVSubscriptionCSS/images/tv-remote.jpg' %}" id="remote-control" alt="Remote Control">
</div>

<script src="{% static 'TVSubscriptionCSS/script.js' %}"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.9/dist/sweetalert2.all.min.js"></script>

<script>
    $(document).ready(function () {
        // Show SweetAlert if user balance is below 50
        {% if user_balance < 50 %}
        Swal.fire({
            icon: 'warning',
            title: 'Balance Too Low',
            text: 'Your balance is too low to make this transaction. Please top up your account.',
            confirmButtonText: 'OK'
        }).then(() => {
            // Redirect after the alert
            window.location.href = "{% url 'index' %}";
        });
        {% endif %}

        // Function to verify the smartcard number via API
        function verifySmartcard(smartcardNumber, serviceID) {
            $('#submit-btn').hide();
            $('#loading-btn').show();
            return $.ajax({
                url: "/api/tvservice/",  // Replace with your backend API endpoint for verification
                type: 'POST',
                data: {
                    'billersCode': smartcardNumber,
                    'serviceID': serviceID,
                    'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val()
                },
                success: function (response) {
                    // Prepare a message to display in SweetAlert, based on the response
                    let message = response.details && response.details.content && response.details.content.error
                        ? response.details.content.error
                        : 'No additional details available.';

                    if (response.status === 'Open') {
                        // If status is 'Open', show success message along with content.error
                        Swal.fire({
                            title: 'Success!',
                            text: 'Smartcard verified.\n\nDetails: ' + message,
                            icon: 'success',
                            confirmButtonText: 'OK'
                        });
                    } else {
                        // If not 'Open', show failure message along with content.error
                        let errorMessage = response.error || 'Smartcard verification failed.';
                        Swal.fire({
                            title: 'Error!',
                            text: errorMessage + '\n\nDetails: ' + message,
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                    $('#loading-btn').hide();  // Hide loading button after success/error
                    $('#submit-btn').show();   // Show original submit button again
                    return true;  // Return true after handling success
                },
                error: function (xhr, status, error) {
                    console.log(error);

                    // Prepare a message to display in SweetAlert, based on the error response
                    let errorMessage = 'Error during smartcard verification. Please try again.';
                    let responseDetails = 'No additional details available.';

                    // Check if the backend returns a detailed error and extract it
                    if (xhr.responseJSON && xhr.responseJSON.details && xhr.responseJSON.details.content) {
                        responseDetails = xhr.responseJSON.details.content.error || responseDetails;
                    }

                    // Use SweetAlert to show the error message and response details
                    Swal.fire({
                        title: 'Error!',
                        text: errorMessage + '\n\nDetails: ' + responseDetails,
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                    $('#loading-btn').hide();  // Hide loading button after success/error
                    $('#submit-btn').show();   // Show original submit button again
                    return false;  // Return false after handling error
                }
            });
        }

        // Listen for changes in the smartcard number fields
        $('#smartcard-number-DSTV, #smartcard-number-GOTV, #smartcard-number-STARTIMES').on('input', function () {
            const smartcardNumber = $(this).val();
            let serviceID = "";

            // Determine the serviceID based on which input field is being updated
            if ($(this).attr('id') === 'smartcard-number-DSTV') {
                serviceID = "DSTV";  // Replace with actual serviceID for DStv
            } else if ($(this).attr('id') === 'smartcard-number-GOTV') {
                serviceID = "GOTV";  // Replace with actual serviceID for GOtv
            } else if ($(this).attr('id') === 'smartcard-number-STARTIMES') {
                serviceID = "STARTIMES";  // Replace with actual serviceID for Startimes
            }

            // Only verify if the smartcard number is 10 characters
            if (smartcardNumber.length === 10) {
                verifySmartcard(smartcardNumber, serviceID).then(function (isVerified) {
                    if (isVerified) {
                        // Update the hidden field for tv_service with the selected serviceID
                        $('#tv_service').val(serviceID);
                    }
                });
            }
        });

        // Handle form submission using AJAX
        $('#tvForm').on('submit', function (e) {
            e.preventDefault(); // Prevent the default form submission

            // Show the loading button and hide the submit button
            $('#submit-btn').hide();
            $('#loading-btn').show();

            // Collect form data
            var formData = {
                'serviceID': $('#tv_service').val(),
                'billersCode': $('#smartcard-number-DSTV').val() || $('#smartcard-number-GOTV').val() || $('#smartcard-number-STARTIMES').val(),
                'iuc-number': $('#smartcard-number-GOTV').val(),
                'startimes-smartcard': $('#smartcard-number-STARTIMES').val(),
                'action': $('#action').val(),
                'bouquet': $('#bouquet').val(),
                'phone_number': $('#phone-number').val(),
                'amount': $('#amount').val(),
                'type': $('#type').val(),
                'csrfmiddlewaretoken': $('input[name="csrfmiddlewaretoken"]').val() // CSRF token
            };

            // Clean up data to ensure only non-empty fields are submitted
            if (!formData['billersCode']) delete formData['smartcard-number'];
            if (!formData['iuc-number']) delete formData['iuc-number'];
            if (!formData['startimes-smartcard']) delete formData['startimes-smartcard'];

            // Send AJAX request
            $.ajax({
                url: "/api/tvservice/",  // URL to your API endpoint
                type: 'POST',
                data: formData,
                success: function (response) {
                    // Handle success, display message or update UI
                    if (response.status === 'successful') {
                        // Use SweetAlert to show a success message
                        Swal.fire({
                            title: 'Success!',
                            text: 'Subscription successful!',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            $('#loading-btn').hide();  // Hide loading button after success/error
                            $('#submit-btn').show();   // Show original submit button again
                        });
                        return true;
                    } else {
                        // Use SweetAlert to show a failure message
                        Swal.fire({
                            title: 'Error!',
                            text: 'Subscription failed! Refund has been issued.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            $('#loading-btn').hide();  // Hide loading button after success/error
                            $('#submit-btn').show();   // Show original submit button again
                        });
                        return false;
                    }
                    $('#tvForm')[0].reset();  // Optionally, clear the form fields after submission
                },
                error: function (xhr, status, error) {
                    // Use SweetAlert to show an error message
                    Swal.fire({
                        title: 'Error!',
                        text: 'There was an error processing your subscription. Please try again.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        $('#loading-btn').hide();  // Hide loading button after success/error
                        $('#submit-btn').show();   // Show original submit button again
                    });
                }
            });
        });
    });
</script>

{% endblock content %}
